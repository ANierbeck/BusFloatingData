<!doctype html>
<html lang="en">
<head>
    <script src="http://ajax.aspnetcdn.com/ajax/jquery/jquery-1.9.0.js"></script>
    <link rel="stylesheet" href="http://openlayers.org/en/v3.15.1/css/ol.css" type="text/css">
    <style type="text/css">
      html, body, #basicMap {
          width: 100%;
          height: 100%;
          margin: 0;
      }
    </style>
    <script src="http://openlayers.org/en/v3.15.1/build/ol-debug.js" type="text/javascript"></script>
    <title>OpenLayers 3 example</title>
</head>
<body>
<div id="map" class="map"></div>
<script type="text/javascript">

      var self = this;

      var center = new ol.Feature({
        geometry: new ol.geom.Point(ol.proj.fromLonLat([-118.23194,34.12527]))
      });

      center.setStyle(new ol.style.Style({
        image: new ol.style.Icon(/** @type {olx.style.IconOptions} */ ({
          color: '#8959A8',
          src: 'data/dot.png'
        }))
      }));


      var vectorSource = new ol.source.Vector({
        features: [center]
      });

      var vectorLayer = new ol.layer.Vector({
        source: vectorSource
      });


      var iconStyle = new ol.style.Style({
            image: new ol.style.Icon(/** @type {olx.style.IconOptions} */ ({
            color: '#0000ff',
            src: 'data/dot.png'
            }))
      });

      self.vehicleSource = new ol.source.Vector();

      var vehicleLayer = new ol.layer.Vector({
        source: self.vehicleSource,
        style: iconStyle
      });

      var rasterLayer = new ol.layer.Tile({
        source: new ol.source.OSM()
      });


      var map = new ol.Map({
        target: 'map',
        layers: [rasterLayer, vectorLayer, vehicleLayer],
        view: new ol.View({
          projection: ol.proj.get('EPSG:3857'),
          center: ol.proj.fromLonLat([-118.23194,34.12527]),
          zoom: 14
        })
      });

      self.akkaServiceBasis = 'http://localhost:8000/vehicles/boundingBox?bbox='

      self.ajax = function(uri) {
          var request = {
              url: uri,
              type: 'GET',
              contentType: "application/json",
              accepts: "application/json",

              cache: false,
              dataType: 'json',
              error: function(jqXHR) {
                  console.log("ajax error " + jqXHR.status);
              }
          };
          return $.ajax(request);
      };

      self.map.on('moveend', function (event) {
          console.log("map move end");

          var mapExtent = self.map.getView().calculateExtent(map.getSize());
          var bottomRight = ol.extent.getBottomRight(mapExtent);
          var topLeft = ol.extent.getTopLeft(mapExtent);
          var brLonLat = ol.proj.toLonLat(bottomRight);
          var tlLonLat = ol.proj.toLonLat(topLeft);

          self.akkaService = self.akkaServiceBasis+tlLonLat[1]+","+tlLonLat[0]+","+brLonLat[1]+","+brLonLat[0];

          self.ajax(self.akkaService).done(function(data) {
              console.log("requested data");
              if (self.vehicleSource.getFeatures().length > 0) {
                console.log("cleared vehicleSource");
                self.vehicleSource.clear();
              }

              for (var i = 0; i < data.length; i++) {
                  var field = data[i];
                  console.log("createing feature for data: "+field.id);
                  var feature = new ol.Feature(field);

                  var latitude = field.latitude;
                  var longitude = field.longitude;
                  var point = new ol.geom.Point(ol.proj.fromLonLat([longitude,latitude]));

                  feature.setGeometry(point)
                  self.vehicleSource.addFeature(feature);
              }

              console.log("feature updated");
          });
      });
    </script>
</body>
</html>